---
title: "Bachelor Post-Processing"
author: "Shiraz Ben Shoshan & Victoria Kanst Husted"
date: "2023-12-10"
output:
  html_document:
      toc: yes
      number_sections: yes
      toc_float: yes
      theme: united
      highlight: espresso
      css: '../../varia/standard.css'
  pdf_document:
    toc: no
    number_sections: yes
geometry: margin=1in
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data')

pacman::p_load(
  tidyverse,
  brms,
  patchwork,
  stringr
)

```

## loading in the data


```{r loading in data}
getwd()

df <- read.csv("data.csv")

```


## creating a new df based on the VR learning method & Furniture

```{r creating a new df}

#creating df based on learning method

video_df <- df %>% 
  filter(condition == "video")

meta_df <- df %>% 
  filter(condition == "meta")

avp_df <- df %>% 
  filter(condition == "apple")

#creating a df based on furniture

reol_df <- df %>% 
  filter(furniture == "reol")

bench_df <- df %>% 
  filter(furniture == "bench")

desk_df <- df %>% 
  filter(furniture == "desk")

```


#creating dataframes with both furniture and learning method
```{r}
reol_video <- df %>% 
  filter(condition == "video" & furniture == "reol")

reol_meta <- df %>% 
  filter(condition == "meta" & furniture == "reol")

reol_avp <- df %>% 
  filter(condition == "apple" & furniture == "reol")

bench_video <- df %>% 
  filter(condition == "video" & furniture == "bench")

bench_meta <- df %>% 
  filter(condition == "meta" & furniture == "bench")

bench_avp <- df %>% 
  filter(condition == "apple" & furniture == "bench")

desk_video <- df %>% 
  filter(condition == "video" & furniture == "desk")

desk_meta <- df %>% 
  filter(condition == "meta" & furniture == "desk")

desk_avp <- df %>% 
  filter(condition == "apple" & furniture == "desk")
```


#creating summaries of the data
```{r summary for all data}
#plotting the time to build based on learning method

#converting reol time to seconds
df_post <- df %>%
  # Process reol_time
  mutate(
    reol_time_parts = strsplit(as.character(reol_time), "\\."),
    reol_minutes = as.numeric(sapply(reol_time_parts, `[`, 1)),
    reol_seconds = as.numeric(sapply(reol_time_parts, `[`, 2)),
    reol_milliseconds = as.numeric(sapply(reol_time_parts, `[`, 3)),
    reol_time_seconds = reol_minutes * 60 + reol_seconds + reol_milliseconds / 1000
  ) %>%
  # Process bench_time
  mutate(
    bench_time_parts = strsplit(as.character(bench_time), "\\."),
    bench_minutes = as.numeric(sapply(bench_time_parts, `[`, 1)),
    bench_seconds = as.numeric(sapply(bench_time_parts, `[`, 2)),
    bench_milliseconds = as.numeric(sapply(bench_time_parts, `[`, 3)),
    bench_time_seconds = bench_minutes * 60 + bench_seconds + bench_milliseconds / 1000
  ) %>%
  # Process desk_time
  mutate(
    desk_time_parts = strsplit(as.character(desk_time), "\\."),
    desk_minutes = as.numeric(sapply(desk_time_parts, `[`, 1)),
    desk_seconds = as.numeric(sapply(desk_time_parts, `[`, 2)),
    desk_milliseconds = as.numeric(sapply(desk_time_parts, `[`, 3)),
    desk_time_seconds = desk_minutes * 60 + desk_seconds + desk_milliseconds / 1000
  )

df_final<- df_post %>% 
  select(-c(reol_time_parts, reol_minutes, reol_seconds, reol_milliseconds, bench_time_parts, bench_minutes, bench_seconds, bench_milliseconds, desk_time_parts, desk_minutes, desk_seconds, desk_milliseconds )) 

# Create a summary data frame with time to build based on condition
df_summary_time <- df_final %>%
  group_by(condition) %>%
  summarize(reol_time = mean(reol_time_seconds, na.rm = TRUE),
            bench_time = mean(bench_time_seconds, na.rm = TRUE),
            desk_time = mean(desk_time_seconds, na.rm = TRUE))

#looking at accuracy
df_summary_acc <- df_final %>%
  group_by(condition) %>%
  summarize(reol_errors = mean(reol_error[reol_error != 0], na.rm = TRUE),
            bench_errors = mean(bench_error[bench_error != 0], na.rm = TRUE),
            desk_errors = mean(desk_error[desk_error != 0], na.rm = TRUE))

#summary of enjoyment
df_summary_enjoyment <- df_final %>%
  summarize(video_enjoyment = mean(enjoy_video, na.rm = TRUE),
            meta_enjoyment = mean(enjoy_meta, na.rm = TRUE),
            apple_enjoyment = mean(enjoy_apple, na.rm = TRUE))

#summary of concentration
df_summary_concentration <- df_final %>%
  summarize(video_conc = mean(conc_video, na.rm = TRUE),
            meta_conc = mean(conc_meta, na.rm = TRUE),
            apple_conc = mean(conc_apple, na.rm = TRUE))

print(df_summary_time)
print(df_summary_acc)
print(df_summary_enjoyment)
print(df_summary_concentration)

```

```{r visualizations}
#making plots to visualize the data

#combining all times to use in graph
df_final <- df_final %>% 
  mutate(
    trial_time_seconds = coalesce(reol_time_seconds, bench_time_seconds, desk_time_seconds)
  )

#making time plot
time_plot <- df_final %>% 
  ggplot(aes(x = condition, y = trial_time_seconds, fill = condition)) +
    facet_wrap(~furniture) + #faceting by furniture for clarity
    geom_bar(stat = 'summary', fun = mean, width = 0.75)+
    geom_errorbar(stat = "summary", fun.data = "mean_se", width = 0.1) + #adding error bars and necessary information to plot graph
    labs(x = "Learning Method", y = "Time Taken To Assemble (s)") +
    ggtitle("Affect of Learning Method on Assembly Time") +
    scale_fill_manual(values = c("#68758E", "#FEDFAB", "#E6A483"))

time_plot
```
#plotting accuracy
```{r}
#combining all accuracy to use in graph
df_final <- df_final %>%
  mutate(
    trial_accuracy = case_when(
      reol_error != 0 ~ reol_error,  # Use reol_error if it's not 0
      bench_error != 0 ~ bench_error,  # Use bench_error if reol_error is 0
      desk_error != 0 ~ desk_error,  # Use desk_error if both previous are 0
      TRUE ~ 0  # If all are 0, set to 0
    )
  )

#making accuracy plot
accuracy_plot <- df_final %>% 
  ggplot(aes(x = condition, y = trial_accuracy, fill = condition)) +
    facet_wrap(~furniture) + #faceting by furniture for clarity
    geom_bar(stat = 'summary', fun = mean, width = 0.75)+
    geom_errorbar(stat = "summary", fun.data = "mean_se", width = 0.1) + #adding error bars and necessary information to plot graph
    labs(x = "Learning Method", y = "Accuracy of Task") +
    ggtitle("Affect of Learning Method on Task Accuracy") +
    scale_fill_manual(values = c("#68758E", "#FEDFAB", "#E6A483"))

accuracy_plot
```

#renaming ikea skills to be in levels
```{r}
#changing ikea skills to following key:
#below = 1
#average = 2
#above = 3

df_final <- df_final %>% 
  mutate(ikea_skills = recode(ikea_skills,
                              "below" = 1,
                              "average" = 2,
                              "above" = 3))

#fixing n.a which appeared in row 10
df_final <- df_final %>%
  mutate(ikea_skills = if_else(row_number() == 10 & is.na(ikea_skills), 2, ikea_skills))
```


#creating models for the comparison of the different conditions
```{r creating formulas}
#creating my formulas for time

formula1 <- brms::bf(trial_time_seconds ~ condition + furniture)
formula2 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number)
formula3 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + sex)
formula4 <- brms::bf(trial_time_seconds ~ condition + furniture + ikea_skills + vr_experience)
formula5 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + ikea_skills + vr_experience)
formula6 <- brms::bf(trial_time_seconds ~ condition * furniture + trial_number + ikea_skills + vr_experience)
formula7 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + ikea_skills + vr_experience + (1| participant_id))
formula8 <- brms::bf(trial_time_seconds ~ condition * furniture + trial_number + ikea_skills + vr_experience + (1| participant_id))
formula9 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + ikea_skills + vr_experience + (trial_number| participant_id))
formula10 <- brms::bf(trial_time_seconds ~ condition * furniture + trial_number + ikea_skills + vr_experience + (trial_number| participant_id))


```

#getting priors for all formulas
```{r getting priors}
#install.packages("sjstats")
pacman::p_load("sjstats")

#formula 1
get_prior(formula1,df_final)
priors1 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 2
get_prior(formula2,df_final)
priors2 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 3
get_prior(formula3,df_final)
priors3 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = sexM),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 4
get_prior(formula4,df_final)
priors4 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 5
get_prior(formula5,df_final)
priors5 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 6
get_prior(formula6,df_final)
priors6 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furnituredesk),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = conditionvideo:furnituredesk),
  prior(normal(0, 1), class = b, coef = conditionvideo:furniturereol),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 7
get_prior(formula7,df_final)
priors7 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, coef = Intercept, group = participant_id, lb = 0)
)

#formula 8
get_prior(formula8,df_final)
priors8 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furnituredesk),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = conditionvideo:furnituredesk),
  prior(normal(0, 1), class = b, coef = conditionvideo:furniturereol),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, coef = Intercept, group = participant_id, lb = 0)
)

#formula 9
get_prior(formula9,df_final)
priors9 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(lkj(1), class = cor),
  prior(lkj(1), class = cor, group = participant_id),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, coef = Intercept, group = participant_id, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, coef = trial_number, group = participant_id, lb = 0)
)

#formula 10
get_prior(formula10,df_final)
priors10 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furnituredesk),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionvideo),
  prior(normal(0, 1), class = b, coef = conditionvideo:furnituredesk),
  prior(normal(0, 1), class = b, coef = conditionvideo:furniturereol),
  prior(normal(0, 1), class = b, coef = furnituredesk),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencenone),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(lkj(1), class = cor),
  prior(lkj(1), class = cor, group = participant_id),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, coef = Intercept, group = participant_id, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, coef = trial_number, group = participant_id, lb = 0)
)

```

#model predictive checking
```{r predictive checking}
model1_prior <- brm(
  formula1,
  df_final,
  family = gaussian,
  prior = priors1,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model1_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model2_prior <- brm(
  formula2,
  df_final,
  family = gaussian,
  prior = priors2,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model2_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model3_prior <- brm(
  formula3,
  df_final,
  family = gaussian,
  prior = priors3,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model3_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model4_prior <- brm(
  formula4,
  df_final,
  family = gaussian,
  prior = priors4,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model4_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model5_prior <- brm(
  formula5,
  df_final,
  family = gaussian,
  prior = priors5,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model5_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model6_prior <- brm(
  formula6,
  df_final,
  family = gaussian,
  prior = priors6,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model6_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model7_prior <- brm(
  formula7,
  df_final,
  family = gaussian,
  prior = priors7,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model7_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model8_prior <- brm(
  formula8,
  df_final,
  family = gaussian,
  prior = priors8,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model8_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model9_prior <- brm(
  formula9,
  df_final,
  family = gaussian,
  prior = priors9,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model9_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model10_prior <- brm(
  formula10,
  df_final,
  family = gaussian,
  prior = priors10,
  sample_prior = "only",
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/VR Bachelor/bachelor_data/models/model10_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

prior_predictive1 <- pp_check(model1_prior, ndraws = 100)
prior_predictive2 <- pp_check(model2_prior, ndraws = 100)
prior_predictive3 <- pp_check(model3_prior, ndraws = 100)
prior_predictive4 <- pp_check(model4_prior, ndraws = 100)
prior_predictive5 <- pp_check(model5_prior, ndraws = 100)
prior_predictive6 <- pp_check(model6_prior, ndraws = 100)
prior_predictive7 <- pp_check(model7_prior, ndraws = 100)
prior_predictive8 <- pp_check(model8_prior, ndraws = 100)
prior_predictive9 <- pp_check(model9_prior, ndraws = 100)
prior_predictive10 <- pp_check(model10_prior, ndraws = 100)


prior_predictive1 + xlim(c(-1000, 30000)) 
prior_predictive2 + xlim(c(-1000, 30000)) 
prior_predictive3 + xlim(c(-1000, 30000)) 
prior_predictive4 + xlim(c(-1000, 30000)) 
prior_predictive5 + xlim(c(-1000, 30000)) 
prior_predictive6 + xlim(c(-1000, 30000)) 
prior_predictive7 + xlim(c(-1000, 30000))
prior_predictive8 + xlim(c(-1000, 30000))
prior_predictive9 + xlim(c(-1000, 30000))
prior_predictive10 + xlim(c(-1000, 30000))
```
#fitting the models
```{r model fitting}
model1 <- brm(
  formula1, 
  df_wc,
  family = shifted_lognormal,
  prior = model1_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model1_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model2 <- brm(
  formula2, 
  df_wc,
  family = shifted_lognormal,
  prior = model2_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model2_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model3 <- brm(
  formula3, 
  df_wc,
  family = shifted_lognormal,
  prior = model3_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model3_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model4 <- brm(
  formula4, 
  df_wc,
  family = shifted_lognormal,
  prior = model4_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model4_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model5 <- brm(
  formula5, 
  df_wc,
  family = shifted_lognormal,
  prior = model5_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model5_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model6 <- brm(
  formula6, 
  df_wc,
  family = shifted_lognormal,
  prior = model6_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model6_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model7 <- brm(
  formula7, 
  df_wc,
  family = shifted_lognormal,
  prior = model7_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '/Users/shirazbenshoshan/Desktop/Cognitive Science/Perception and Action Exam Research/PA_Exam_R/models/model7_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )
```


#model quality checks
```{r quality checks}
model1
plot(model1)
model2
plot(model2)
model3
plot(model3)
model4
plot(model4)
model5
plot(model5)
model6
plot(model6)
model7
plot(model7)
```
#model comparison
```{r}
posterior_predictive1 <- pp_check(model1, ndraws = 100)
posterior_predictive2 <- pp_check(model2, ndraws = 100)
posterior_predictive3 <- pp_check(model3, ndraws = 100)
posterior_predictive4 <- pp_check(model4, ndraws = 100)
posterior_predictive5 <- pp_check(model5, ndraws = 100)
posterior_predictive6 <- pp_check(model6, ndraws = 100)
posterior_predictive7 <- pp_check(model7, ndraws = 100)

posterior_predictive1
posterior_predictive2
posterior_predictive3
posterior_predictive4
posterior_predictive5
posterior_predictive6
posterior_predictive7

m1 <- add_criterion(model1, criterion = "loo")
m2 <- add_criterion(model2, criterion = "loo")
m3 <- add_criterion(model3, criterion = "loo")
m4 <- add_criterion(model4, criterion = "loo")
m5 <- add_criterion(model5, criterion = "loo")
m6 <- add_criterion(model6, criterion = "loo")
m7 <- add_criterion(model7, criterion = "loo")

waic(model1)
waic(model2)
waic(model3)
waic(model4)
waic(model5)
waic(model6)
waic(model7)

loo_compare(m1, m2, m3, m4, m5, m6, m7)
loo_model_weights(m1, m2, m3, m4, m5, m6, m7)

bayes_R2(model1)
bayes_R2(model2)
bayes_R2(model3)
bayes_R2(model4)
bayes_R2(model5)
bayes_R2(model6)
bayes_R2(model7)
```

#finding out what the best model says about the data
```{r looking at the best model}
summary(model7)

library(vip)


# Variable importance based on BMA
var_imp <- conditional_effects(model7)

# Plot variable importance
plot(var_imp)
```

only the predictor of bird familiarity ci_bf_correct is the only predictor showing strong evidence of association with changes in response_time. The 95% credible interval for ci_bf_correct does not include zero, suggesting a credible effect on the response variable. Since the entire interval (-135.34 to -99.50) does not include zero, we can say that the predictor ci_bf_correct is credibly different from zero. In other words, there is evidence that changes in ci_bf_correct are associated with changes in response_time. This is often interpreted as a credible effect or significance in Bayesian terms.

###Mouse Tracking Part

```{r defining mousetracking function}
#creating a dataframe for mousetracking just so we have one that is different so nothing changes above
df_mt <- df_wc %>% 
  rename(subject_id = subject_nr)

#creating a function to split the x and y coordinates
scale_raw_mousetrap_data <- function(df_mt) {
  # Split data
  scale_raw_data <- function(x) {
    # helper function https://github.com/PascalKieslich/mousetrap/blob/master/R/import.R#L226C3-L243C66
    split <- ","
    # Remove all irrelevant characters
    x <- gsub(pattern=paste0("[^-e0123456789.",split,"]"),replacement = "", x)

    # Remove leading / end / double split characters
    x <- gsub(pattern=paste0("^",split),replacement = "", x)
    x <- gsub(pattern=paste0(split,"$"),replacement = "", x)
    x <- gsub(pattern=paste0(split,split),replacement = "", x)

    # Split according to specified character
    x <- strsplit(x, split=split)

    return(as.numeric(unlist(x)))
  }
  # get subject row indices by unique "subject_id" and "experiment_start_time" (in case two have the same id)
  idxs <- df_mt %>%
    mutate(
      idx = row_number()
    ) %>%
    select(
      idx,
      subject_id
    )

  # now loop and scale/standardize each subject's data
  for (i in unique(idxs$subject_id)) {
    # get the indices for this subject
    idxs_sub <- idxs %>%
      filter(
        subject_id == i
      ) %>%
      pull(
        idx
      )

    # get the data for this subject
    subj_pos_data <- apply(
      df[idxs_sub, c(
          'xpos_tracking',
          'ypos_tracking'
        )
      ],
      c(1, 2),
      scale_raw_data
    )

    # get the lengths of the lists
    xpos_lengths <- sapply(subj_pos_data[, 'xpos_tracking'], length)
    ypos_lengths <- sapply(subj_pos_data[, 'ypos_tracking'], length)

    # flatten and scale the lists
    flattened_xpos <- scale(unlist(subj_pos_data[, 'xpos_tracking']))
    flattened_ypos <- scale(unlist(subj_pos_data[, 'ypos_tracking']))

    # put the data back together
    for (j in 1:length(idxs_sub)) {
      df[idxs_sub[j], 'xpos_tracking'] <- paste(flattened_xpos[1:xpos_lengths[j]], collapse = ',')
      df[idxs_sub[j], 'ypos_tracking'] <- paste(flattened_ypos[1:ypos_lengths[j]], collapse = ',')

      flattened_xpos <- flattened_xpos[(xpos_lengths[j] + 1):length(flattened_xpos)]
      flattened_ypos <- flattened_ypos[(ypos_lengths[j] + 1):length(flattened_ypos)]
    }
  }
  return(df_mt)
}
```

#loading in packages
```{r loading in necessary packages}
#loading in packages
pacman::p_load(mousetrap, tidyverse, readbulk)
```

#loading in the mousetracking data specifically
```{r loading in mousetracking data}

mt_data <- mt_import_mousetrap(
  df_mt, xpos_label = "xpos_mouse_1", ypos_label = "ypos_mouse_1", timestamps_label = "timestamps_mouse_1",
    verbose = TRUE
)

```

#plot the coniditons answers
```{r plot condition answers}
#making plot per condition bird familiar
mt_plot(mt_data, color = 'response', wrap_var = 'ci_bf_correct') + scale_y_reverse()

#plotting condition of color cool
mt_plot(mt_data, color = 'response', wrap_var = 'ci_cc_correct') + scale_y_reverse()

#plotting condition of kiki-bouba
mt_plot(mt_data, color = 'response', wrap_var = 'ci_nbsr_nkss_correct') + scale_y_reverse()
```

#mapping the trajectories
```{r}
# for touchtracker data, 1st align starts
mt_data <- mt_align_start(
  mt_data,
  use = 'trajectories',
  dimensions = c("xpos", "ypos")
)

str(mt_data)

mt_plot(
  mt_data, 
  use = 'trajectories',
  color = 'response',
  wrap_var = 'ci_bf_correct',
  x = 'xpos',
  y = 'ypos'
) +
  scale_y_reverse()

# now we can remap the trajectories
# for touchtracker data
mt_data <- mt_remap_symmetric(
  mt_data, 
  use = 'trajectories',
  remap_xpos = "right",
  remap_ypos = "up" 
)

# plot again
mt_plot(
  mt_data, 
  use = 'trajectories',
  color = 'subject_id',
  wrap_var = 'ci_bf_correct',
)
```

#cleaning the data
```{r}
#removing the initiation time
data_norm <- mt_exclude_initiation(mt_data)


mt_plot(
  data_norm, 
  x = 'timestamps', # modifying the x-axis to plot timestamps
  y = 'xpos',       # modifying the y-axis to plot the xpos
  use = 'trajectories',
)

#normalizing the time
data_norm <- mt_time_normalize(mt_data)

mt_plot(
  data_norm, 
  x = 'timestamps', # modifying the x-axis to plot timestamps
  y = 'xpos',       # modifying the y-axis to plot the xpos
  use = 'tn_trajectories'
)

#trying out different time normalized options
mt_tn <- mt_time_normalize(
  data_norm,
  nsteps = 101
)

#plot
mt_plot(
  mt_tn, 
  use = 'tn_trajectories',
  color = "subject_id"
)

```

#aggregating the data in the plots 
```{r}
mt_plot_aggregate(
  mt_tn, 
  use = 'trajectories',
  color = 'response'
)

#aggregated tn mouse trajectories for the bird condition
mt_plot_aggregate(
  mt_tn, 
  use = 'tn_trajectories',
  color = 'ci_bf_correct'
) + 
  labs(
    title = 'Aggregated mouse trajectories for the bird condition')


#aggregated tn mouse trajectories for the color condition
mt_plot_aggregate(
  mt_tn, 
  use = 'tn_trajectories',
  color = 'ci_cc_correct'
) + 
  labs(
    title = 'Aggregated time-normalized mouse trajectories for color condition')

#aggregated tn mouse trajectories for the kiki-bouba condition
mt_plot_aggregate(
  mt_tn, 
  use = 'tn_trajectories',
  color = 'ci_nbsr_nkss_correct'
) + 
  labs(
    title = 'Aggregated time-normalized mouse trajectories for kiki-bouba condition')
```

#aggregating measures
```{r}
#applying measures function to look at outcome of data
mt_tn <- mt_measures(mt_tn, use = 'tn_trajectories')

mt_tn

mt_measures_ag <- mt_aggregate(
  mt_tn,
  use = 'measures',
  use_variables = c('MAD', 'xpos_flips','AUC', 'RT'), # if you want all of the measures, exclude this line
  use2_variables = c('ci_bf_correct', 'ci_cc_correct', 'ci_nbsr_nkss_correct')
  )

mt_measures_ag
  
```

more on understanding auc in mouse tracking:
Direction of Movement: Positive AUC values typically indicate a smooth and efficient movement toward the target, while negative values might suggest less efficient or less direct movements. It's important to understand the specific directionality and meaning assigned to positive and negative values in your experimental setup.

Decision-Making Dynamics: AUC in the context of a decision point between left and right buttons might also reflect decision-making dynamics. A higher (more positive) AUC could imply a more direct and confident decision, while a lower (more negative) AUC might indicate more hesitation or wavering in the decision process.

Individual Differences: Participants with more consistent and efficient movements may have higher AUC values, while participants with more variable or less efficient movements may have lower AUC values.

#trying to visualize the AUC scores
```{r visualizing AUC scores}
#making ggplor of AUC scores
ggplot(mt_measures_ag, aes(x = interaction(ci_bf_correct, ci_cc_correct, ci_nbsr_nkss_correct), y = AUC)) +
  geom_point() +
  labs(x = "Conditions", y = "AUC Values") +
  theme_minimal()

#making barplot as well
ggplot(mt_measures_ag, aes(x = interaction(ci_bf_correct, ci_cc_correct, ci_nbsr_nkss_correct), y = AUC)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge", fill = "skyblue") +
  labs(x = "Conditions", y = "Mean AUC Values") +
  theme_minimal()
```
#making a new df with auc measures for all trials
```{r df with auc}
#df with AUC scores etc. 

#new mousetracking df for predicting auc
df_auc <- mt_measures(
  mt_tn,
  use = c('MAD', 'xpos_flips', 'AUC', 'RT')
)

df_auc <- mt_add_variables(
  mt_tn, use = "trajectories", variables = 'AUC')

head(df_auc)
```

#defining new formulas 
```{r defining formulas for auc}
formula8 <- brms::bf(AUC ~ ci_bf_correct + ci_cc_correct + ci_nbsr_nkss_correct)
formula9 <- brms::bf(AUC ~ ci_bf_correct*ci_cc_correct*ci_nbsr_nkss_correct)
formula10 <- brms::bf(AUC ~ ci_bf_correct*ci_cc_correct*ci_nbsr_nkss_correct + age)
formula11 <- brms::bf(AUC ~ ci_bf_correct*ci_cc_correct*ci_nbsr_nkss_correct + gender)
formula12 <- brms::bf(AUC ~ ci_bf_correct*ci_cc_correct*ci_nbsr_nkss_correct + gender + country)
formula13 <- brms::bf(AUC ~ ci_bf_correct*ci_cc_correct*ci_nbsr_nkss_correct + gender + country + (1|subject_nr))
formula14 <- brms::bf(AUC ~ ci_bf_correct*ci_cc_correct*ci_nbsr_nkss_correct + gender + country + initiation_time + (1 + initiation_time|subject_nr))

```

#defining priors for AUC predictions
```{r}

```














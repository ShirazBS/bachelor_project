---
title: "Bachelor Post-Processing"
author: "Shiraz Ben Shoshan & Victoria Kanst Husted"
date: "2023-12-10"
output:
  html_document:
      toc: yes
      number_sections: yes
      toc_float: yes
      theme: united
      highlight: espresso
      css: '../../varia/standard.css'
  pdf_document:
    toc: no
    number_sections: yes
geometry: margin=1in
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/Desktop')

pacman::p_load(
  tidyverse,
  brms,
  patchwork,
  stringr
)

```

## loading in the data


```{r loading in data}
getwd()

df <- read.csv("data.csv")

```


## creating a new df based on the VR learning method & Furniture

```{r creating a new df}

#creating df based on learning method

video_df <- df %>% 
  filter(condition == "video")

meta_df <- df %>% 
  filter(condition == "meta")

avp_df <- df %>% 
  filter(condition == "apple")

#creating a df based on furniture

reol_df <- df %>% 
  filter(furniture == "reol")

bench_df <- df %>% 
  filter(furniture == "bench")

desk_df <- df %>% 
  filter(furniture == "desk")

```


#creating dataframes with both furniture and learning method
```{r}
reol_video <- df %>% 
  filter(condition == "video" & furniture == "reol")

reol_meta <- df %>% 
  filter(condition == "meta" & furniture == "reol")

reol_avp <- df %>% 
  filter(condition == "apple" & furniture == "reol")

bench_video <- df %>% 
  filter(condition == "video" & furniture == "bench")

bench_meta <- df %>% 
  filter(condition == "meta" & furniture == "bench")

bench_avp <- df %>% 
  filter(condition == "apple" & furniture == "bench")

desk_video <- df %>% 
  filter(condition == "video" & furniture == "desk")

desk_meta <- df %>% 
  filter(condition == "meta" & furniture == "desk")

desk_avp <- df %>% 
  filter(condition == "apple" & furniture == "desk")
```


#creating summaries of the data
```{r summary for all data}
#plotting the time to build based on learning method

#converting reol time to seconds
df_post <- df %>%
  # Process reol_time
  mutate(
    reol_time_parts = strsplit(as.character(reol_time), "\\."),
    reol_minutes = as.numeric(sapply(reol_time_parts, `[`, 1)),
    reol_seconds = as.numeric(sapply(reol_time_parts, `[`, 2)),
    reol_milliseconds = as.numeric(sapply(reol_time_parts, `[`, 3)),
    reol_time_seconds = reol_minutes * 60 + reol_seconds + reol_milliseconds / 1000
  ) %>%
  # Process bench_time
  mutate(
    bench_time_parts = strsplit(as.character(bench_time), "\\."),
    bench_minutes = as.numeric(sapply(bench_time_parts, `[`, 1)),
    bench_seconds = as.numeric(sapply(bench_time_parts, `[`, 2)),
    bench_milliseconds = as.numeric(sapply(bench_time_parts, `[`, 3)),
    bench_time_seconds = bench_minutes * 60 + bench_seconds + bench_milliseconds / 1000
  ) %>%
  # Process desk_time
  mutate(
    desk_time_parts = strsplit(as.character(desk_time), "\\."),
    desk_minutes = as.numeric(sapply(desk_time_parts, `[`, 1)),
    desk_seconds = as.numeric(sapply(desk_time_parts, `[`, 2)),
    desk_milliseconds = as.numeric(sapply(desk_time_parts, `[`, 3)),
    desk_time_seconds = desk_minutes * 60 + desk_seconds + desk_milliseconds / 1000
  )

df_final<- df_post %>% 
  select(-c(reol_time_parts, reol_minutes, reol_seconds, reol_milliseconds, bench_time_parts, bench_minutes, bench_seconds, bench_milliseconds, desk_time_parts, desk_minutes, desk_seconds, desk_milliseconds )) 

# Create a summary data frame with time to build based on condition
df_summary_time <- df_final %>%
  group_by(condition) %>%
  summarize(reol_time = mean(reol_time_seconds, na.rm = TRUE),
            bench_time = mean(bench_time_seconds, na.rm = TRUE),
            desk_time = mean(desk_time_seconds, na.rm = TRUE))

#looking at accuracy
df_summary_acc <- df_final %>%
  group_by(condition) %>%
  summarize(reol_errors = mean(reol_error[reol_error != 0], na.rm = TRUE),
            bench_errors = mean(bench_error[bench_error != 0], na.rm = TRUE),
            desk_errors = mean(desk_error[desk_error != 0], na.rm = TRUE))

#summary of enjoyment
df_summary_enjoyment <- df_final %>%
  summarize(video_enjoyment = mean(enjoy_video, na.rm = TRUE),
            meta_enjoyment = mean(enjoy_meta, na.rm = TRUE),
            apple_enjoyment = mean(enjoy_apple, na.rm = TRUE))

#summary of concentration
df_summary_concentration <- df_final %>%
  summarize(video_conc = mean(conc_video, na.rm = TRUE),
            meta_conc = mean(conc_meta, na.rm = TRUE),
            apple_conc = mean(conc_apple, na.rm = TRUE))

print(df_summary_time)
print(df_summary_acc)
print(df_summary_enjoyment)
print(df_summary_concentration)

```

```{r visualizations}
#making plots to visualize the data

#combining all times to use in graph
df_final <- df_final %>% 
  mutate(
    trial_time_seconds = coalesce(reol_time_seconds, bench_time_seconds, desk_time_seconds)
  )

#making time plot
time_plot <- df_final %>% 
  ggplot(aes(x = condition, y = trial_time_seconds, fill = condition)) +
    facet_wrap(~furniture) + #faceting by furniture for clarity
    geom_bar(stat = 'summary', fun = mean, width = 0.75)+
    geom_errorbar(stat = "summary", fun.data = "mean_se", width = 0.1) + #adding error bars and necessary information to plot graph
    labs(x = "Learning Method", y = "Time Taken To Assemble (s)") +
    ggtitle("Affect of Learning Method on Assembly Time") +
    scale_fill_manual(values = c("#68758E", "#FEDFAB", "#E6A483"))

time_plot
```
#plotting accuracy
```{r}
#combining all accuracy to use in graph
df_final <- df_final %>%
  mutate(
    trial_accuracy = case_when(
      reol_error != 0 ~ reol_error,  # Use reol_error if it's not 0
      bench_error != 0 ~ bench_error,  # Use bench_error if reol_error is 0
      desk_error != 0 ~ desk_error,  # Use desk_error if both previous are 0
      TRUE ~ 0  # If all are 0, set to 0
    )
  )

#making accuracy plot
accuracy_plot <- df_final %>% 
  ggplot(aes(x = condition, y = trial_accuracy, fill = condition)) +
    facet_wrap(~furniture) + #faceting by furniture for clarity
    geom_bar(stat = 'summary', fun = mean, width = 0.75)+
    geom_errorbar(stat = "summary", fun.data = "mean_se", width = 0.1) + #adding error bars and necessary information to plot graph
    labs(x = "Learning Method", y = "Accuracy of Task") +
    ggtitle("Affect of Learning Method on Task Accuracy") +
    scale_fill_manual(values = c("#68758E", "#FEDFAB", "#E6A483"))

accuracy_plot
```

#renaming ikea skills to be in levels
```{r}
#changing ikea skills to following key:
#below = 1
#average = 2
#above = 3

df_final <- df_final %>% 
  mutate(ikea_skills = recode(ikea_skills,
                              "below" = 1,
                              "average" = 2,
                              "above" = 3))

#fixing n.a which appeared in row 10
df_final <- df_final %>%
  mutate(ikea_skills = if_else(row_number() == 10 & is.na(ikea_skills), 2, ikea_skills))

df_final <- df_final %>%
  mutate(
    vr_experience = factor(vr_experience, levels = c("none", "some", "much")),
    condition = factor(condition, levels = c("video", "meta", "apple")),
    furniture = factor(furniture, levels = c("desk", "reol", "bench")),
    ikea_skills = factor(ikea_skills, levels = c(1, 2, 3)) # Ensure it's treated as a factor
  )
```


#creating models for the comparison of the different conditions
```{r creating formulas}
#creating my formulas for time

formula1 <- brms::bf(trial_time_seconds ~ condition + furniture)
formula2 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number)
formula3 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + sex)
formula4 <- brms::bf(trial_time_seconds ~ condition + furniture + ikea_skills + vr_experience)
formula5 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + ikea_skills + vr_experience)
formula6 <- brms::bf(trial_time_seconds ~ condition * furniture + trial_number + ikea_skills + vr_experience)
formula7 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + ikea_skills + vr_experience + (1| participant_id))
formula8 <- brms::bf(trial_time_seconds ~ condition * furniture + trial_number + ikea_skills + vr_experience + (1| participant_id))
formula9 <- brms::bf(trial_time_seconds ~ condition + furniture + trial_number + ikea_skills + vr_experience + (trial_number| participant_id))
formula10 <- brms::bf(trial_time_seconds ~ condition * furniture + trial_number + ikea_skills + vr_experience + (trial_number| participant_id))


```

#getting priors for all formulas
```{r getting priors}
#install.packages("sjstats")
pacman::p_load("sjstats")

#formula 1
get_prior(formula1,df_final)
priors1 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 2
get_prior(formula2,df_final)
priors2 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 3
get_prior(formula3,df_final)
priors3 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = sexM),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 4
get_prior(formula4,df_final)
priors4 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 5
get_prior(formula5,df_final)
priors5 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 6
get_prior(formula6,df_final)
priors6 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0)
)

#formula 7
get_prior(formula7,df_final)
priors7 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0)
)

#formula 8
get_prior(formula8,df_final)
priors8 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0)
)

#formula 9
get_prior(formula9,df_final)
priors9 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(lkj(1), class = cor),
  prior(lkj(1), class = cor, group = participant_id),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0)
)

#formula 10
get_prior(formula10,df_final)
priors10 <- c(
  prior(student_t(3, 900, 424.8), class = Intercept, lb = 0),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(lkj(1), class = cor),
  prior(lkj(1), class = cor, group = participant_id),
  prior(student_t(3, 0, 424.8), class = sigma, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, lb = 0),
  prior(student_t(3, 0, 424.8), class = sd, group = participant_id, lb = 0)
)

```

#model predictive checking
```{r predictive checking}
model1_prior <- brm(
  formula1,
  df_final,
  family = gaussian,
  prior = priors1,
  sample_prior = "only",
  file = '~/Desktop/model1_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model2_prior <- brm(
  formula2,
  df_final,
  family = gaussian,
  prior = priors2,
  sample_prior = "only",
  file = '~/Desktop/model2_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model3_prior <- brm(
  formula3,
  df_final,
  family = gaussian,
  prior = priors3,
  sample_prior = "only",
  file = '~/Desktop/model3_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model4_prior <- brm(
  formula4,
  df_final,
  family = gaussian,
  prior = priors4,
  sample_prior = "only",
  file = '~/Desktop/model4_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model5_prior <- brm(
  formula5,
  df_final,
  family = gaussian,
  prior = priors5,
  sample_prior = "only",
  file = '~/Desktop/model5_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model6_prior <- brm(
  formula6,
  df_final,
  family = gaussian,
  prior = priors6,
  sample_prior = "only",
  file = '~/Desktop/model6_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model7_prior <- brm(
  formula7,
  df_final,
  family = gaussian,
  prior = priors7,
  sample_prior = "only",
  file = '~/Desktop/model7_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model8_prior <- brm(
  formula8,
  df_final,
  family = gaussian,
  prior = priors8,
  sample_prior = "only",
  file = '~/Desktop/model8_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model9_prior <- brm(
  formula9,
  df_final,
  family = gaussian,
  prior = priors9,
  sample_prior = "only",
  file = '~/Desktop/model9_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model10_prior <- brm(
  formula10,
  df_final,
  family = gaussian,
  prior = priors10,
  sample_prior = "only",
  file = '~/Desktop/model10_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

prior_predictive1 <- pp_check(model1_prior, ndraws = 100)
prior_predictive2 <- pp_check(model2_prior, ndraws = 100)
prior_predictive3 <- pp_check(model3_prior, ndraws = 100)
prior_predictive4 <- pp_check(model4_prior, ndraws = 100)
prior_predictive5 <- pp_check(model5_prior, ndraws = 100)
prior_predictive6 <- pp_check(model6_prior, ndraws = 100)
prior_predictive7 <- pp_check(model7_prior, ndraws = 100)
prior_predictive8 <- pp_check(model8_prior, ndraws = 100)
prior_predictive9 <- pp_check(model9_prior, ndraws = 100)
prior_predictive10 <- pp_check(model10_prior, ndraws = 100)


prior_predictive1 + xlim(c(-1000, 30000)) 
prior_predictive2 + xlim(c(-1000, 30000)) 
prior_predictive3 + xlim(c(-1000, 30000)) 
prior_predictive4 + xlim(c(-1000, 30000)) 
prior_predictive5 + xlim(c(-1000, 30000)) 
prior_predictive6 + xlim(c(-1000, 30000)) 
prior_predictive7 + xlim(c(-1000, 30000))
prior_predictive8 + xlim(c(-1000, 30000))
prior_predictive9 + xlim(c(-1000, 30000))
prior_predictive10 + xlim(c(-1000, 30000))
```
#fitting the models
```{r model fitting}
model1 <- brm(
  formula1, 
  df_final,
  family = gaussian(),
  prior = model1_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model1_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model2 <- brm(
  formula2, 
  df_final,
  family = gaussian(),
  prior = model2_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model2_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model3 <- brm(
  formula3, 
  df_final,
  family = gaussian(),
  prior = model3_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model3_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model4 <- brm(
  formula4, 
  df_final,
  family = gaussian(),
  prior = model4_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model4_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model5 <- brm(
  formula5, 
  df_final,
  family = gaussian(),
  prior = model5_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model5_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model6 <- brm(
  formula6, 
  df_final,
  family = gaussian(),
  prior = model6_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model6_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model7 <- brm(
  formula7, 
  df_final,
  family = gaussian(),
  prior = model7_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model7_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model8 <- brm(
  formula8, 
  df_final,
  family = gaussian(),
  prior = model8_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model8_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model9 <- brm(
  formula9, 
  df_final,
  family = gaussian(),
  prior = model9_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model9_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model10 <- brm(
  formula10, 
  df_final,
  family = gaussian(),
  prior = model10_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model10_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )
```


#model quality checks
```{r quality checks}
model1
plot(model1)
model2
plot(model2)
model3
plot(model3)
model4
plot(model4)
model5
plot(model5)
model6
plot(model6)
model7
plot(model7)
model8
plot(model8)
model9
plot(model9)
model10
plot(model10)
```
#model comparison
```{r}
posterior_predictive1 <- pp_check(model1, ndraws = 100)
posterior_predictive2 <- pp_check(model2, ndraws = 100)
posterior_predictive3 <- pp_check(model3, ndraws = 100)
posterior_predictive4 <- pp_check(model4, ndraws = 100)
posterior_predictive5 <- pp_check(model5, ndraws = 100)
posterior_predictive6 <- pp_check(model6, ndraws = 100)
posterior_predictive7 <- pp_check(model7, ndraws = 100)
posterior_predictive8 <- pp_check(model8, ndraws = 100)
posterior_predictive9 <- pp_check(model9, ndraws = 100)
posterior_predictive10 <- pp_check(model10, ndraws = 100)

posterior_predictive1
posterior_predictive2
posterior_predictive3
posterior_predictive4
posterior_predictive5
posterior_predictive6
posterior_predictive7
posterior_predictive8
posterior_predictive9
posterior_predictive10

m1 <- add_criterion(model1, criterion = "loo")
m2 <- add_criterion(model2, criterion = "loo")
m3 <- add_criterion(model3, criterion = "loo")
m4 <- add_criterion(model4, criterion = "loo")
m5 <- add_criterion(model5, criterion = "loo")
m6 <- add_criterion(model6, criterion = "loo")
m7 <- add_criterion(model7, criterion = "loo")
m8 <- add_criterion(model8, criterion = "loo")
m9 <- add_criterion(model9, criterion = "loo")
m10 <- add_criterion(model10, criterion = "loo")

waic(model1)
waic(model2)
waic(model3)
waic(model4)
waic(model5)
waic(model6)
waic(model7)
waic(model8)
waic(model9)
waic(model10)

loo_compare(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10)
loo_model_weights(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10)

bayes_R2(model1)
bayes_R2(model2)
bayes_R2(model3)
bayes_R2(model4)
bayes_R2(model5)
bayes_R2(model6)
bayes_R2(model7)
bayes_R2(model8)
bayes_R2(model9)
bayes_R2(model10)
```

#finding out what the best model says about the data
```{r looking at the best model}
summary(m5)

library(vip)


# Variable importance based on BMA
var_imp <- conditional_effects(m5)

# Plot variable importance
plot(var_imp)
```
#making the accuracy a factor
```{r}
df_final$trial_accuracy = as.factor(df_final$trial_accuracy)

is.factor(df_final$trial_accuracy)

df_final$trial_accuracy <- factor(df_final$trial_accuracy,
                                  levels = c(0, 1, 2, 3, 4, 5, 6),
                                  ordered = TRUE)
```


#creating models for the comparison of the different conditions
```{r creating formulas}
#creating my formulas for accuracy

formula20 <- brms::bf(trial_accuracy ~ condition + furniture)
formula21 <- brms::bf(trial_accuracy ~ condition + furniture + trial_number)
formula22 <- brms::bf(trial_accuracy ~ condition + furniture + trial_number + sex)
formula23 <- brms::bf(trial_accuracy ~ condition + furniture + ikea_skills + vr_experience)
formula24 <- brms::bf(trial_accuracy ~ condition + furniture + trial_number + ikea_skills + vr_experience)
formula25 <- brms::bf(trial_accuracy ~ condition * furniture + trial_number + ikea_skills + vr_experience)
formula26 <- brms::bf(trial_accuracy ~ condition + furniture + trial_number + ikea_skills + vr_experience + (1| participant_id))
formula27 <- brms::bf(trial_accuracy ~ condition * furniture + trial_number + ikea_skills + vr_experience + (1| participant_id))

```

#getting priors for all formulas
```{r getting priors}
#install.packages("sjstats")
pacman::p_load("sjstats")

#formula 20
get_prior(formula20,df_final)
priors20 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol)
)

#formula 21
get_prior(formula21,df_final)
priors21 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = trial_number)
  )

#formula 22
get_prior(formula22,df_final)
priors22 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = sexM),
  prior(normal(0, 1), class = b, coef = trial_number)
)

#formula 23
get_prior(formula23,df_final)
priors23 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome)
)

#formula 24
get_prior(formula24,df_final)
priors24 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome)
)

#formula 25
get_prior(formula25,df_final)
priors25 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome)
)

#formula 26
get_prior(formula26,df_final)
priors26 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 2.5), class = sd),
  prior(student_t(3, 0, 2.5), class = sd, group = participant_id)
)

#formula 27
get_prior(formula27,df_final)
priors27 <- c(
  prior(student_t(3, 3, 2.5), class = Intercept),
  prior(normal(0, 1), class = b, coef = conditionapple),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionapple:furniturereol),
  prior(normal(0, 1), class = b, coef = conditionmeta),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturebench),
  prior(normal(0, 1), class = b, coef = conditionmeta:furniturereol),
  prior(normal(0, 1), class = b, coef = furniturebench),
  prior(normal(0, 1), class = b, coef = furniturereol),
  prior(normal(0, 1), class = b, coef = ikea_skills2),
  prior(normal(0, 1), class = b, coef = ikea_skills3),
  prior(normal(0, 1), class = b, coef = trial_number),
  prior(normal(0, 1), class = b, coef = vr_experiencemuch),
  prior(normal(0, 1), class = b, coef = vr_experiencesome),
  prior(student_t(3, 0, 2.5), class = sd),
  prior(student_t(3, 0, 2.5), class = sd, group = participant_id)
)

```

#model predictive checking
```{r predictive checking}
model20_prior <- brm(
  formula20,
  df_final,
  family = cumulative(),
  prior = priors20,
  sample_prior = "only",
  file = '~/Desktop/model20_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model21_prior <- brm(
  formula21,
  df_final,
  family = cumulative(),
  prior = priors21,
  sample_prior = "only",
  file = '~/Desktop/model21_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model22_prior <- brm(
  formula22,
  df_final,
  family = cumulative(),
  prior = priors22,
  sample_prior = "only",
  file = '~/Desktop/model22_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model23_prior <- brm(
  formula23,
  df_final,
  family = cumulative(),
  prior = priors23,
  sample_prior = "only",
  file = '~/Desktop/model23_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model24_prior <- brm(
  formula24,
  df_final,
  family = cumulative(),
  prior = priors24,
  sample_prior = "only",
  file = '~/Desktop/model24_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model25_prior <- brm(
  formula25,
  df_final,
  family = cumulative(),
  prior = priors25,
  sample_prior = "only",
  file = '~/Desktop/model25_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model26_prior <- brm(
  formula26,
  df_final,
  family = cumulative(),
  prior = priors26,
  sample_prior = "only",
  file = '~/Desktop/model26_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)

model27_prior <- brm(
  formula27,
  df_final,
  family = cumulative(),
  prior = priors27,
  sample_prior = "only",
  file = '~/Desktop/model27_prior',
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  seed = 112
)


prior_predictive20 <- pp_check(model20_prior, ndraws = 100)
prior_predictive21 <- pp_check(model21_prior, ndraws = 100)
prior_predictive22 <- pp_check(model22_prior, ndraws = 100)
prior_predictive23 <- pp_check(model23_prior, ndraws = 100)
prior_predictive24 <- pp_check(model24_prior, ndraws = 100)
prior_predictive25 <- pp_check(model25_prior, ndraws = 100)
prior_predictive26 <- pp_check(model26_prior, ndraws = 100)
prior_predictive27 <- pp_check(model27_prior, ndraws = 100)


prior_predictive20 + xlim(c(-1000, 30000)) 
prior_predictive21 + xlim(c(-1000, 30000)) 
prior_predictive22 + xlim(c(-1000, 30000)) 
prior_predictive23 + xlim(c(-1000, 30000)) 
prior_predictive24 + xlim(c(-1000, 30000)) 
prior_predictive25 + xlim(c(-1000, 30000)) 
prior_predictive26 + xlim(c(-1000, 30000))
prior_predictive27 + xlim(c(-1000, 30000))
```
#fitting the models
```{r}
model20 <- brm(
  formula = formula20, 
  data = df_final,
  family = cumulative(),
  prior = model20_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model20_fit',
  seed = 112
)

model21 <- brm(
  formula21, 
  df_final,
  family = cumulative(),
  prior = model21_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model21_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model22 <- brm(
  formula22, 
  df_final,
  family = cumulative(),
  prior = model22_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model22_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model23 <- brm(
  formula23, 
  df_final,
  family = cumulative(),
  prior = model23_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model23_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model24 <- brm(
  formula24, 
  df_final,
  family = cumulative(),
  prior = model24_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model24_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model25 <- brm(
  formula25, 
  df_final,
  family = cumulative(),
  prior = model25_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model25_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model26 <- brm(
  formula26, 
  df_final,
  family = cumulative(),
  prior = model26_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model26_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )

model27 <- brm(
  formula27, 
  df_final,
  family = cumulative(),
  prior = model27_prior$prior,
  backend = "cmdstanr",
  chains = 8,
  cores = 8,
  threads = threading(2),
  control = list(
    adapt_delta = 0.9,
    max_treedepth = 20),
  file = '~/Desktop/model27_fit',
  stan_model_args = list(stanc_options = list("O1")),
  seed = 112,
  save_all_pars = TRUE
  )
```







